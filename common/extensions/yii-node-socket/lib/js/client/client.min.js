(function(){var f={};var h={};var d={};var l;function c(){this.isDebugMode=false;var p=window.console||{info:function(){},log:function(){},error:function(){}};if(!p.log){p.log=function(){}}if(!p.error){p.error=function(){}}if(!p.info){p.info=function(){}}this.log=function(q){if(this.isDebugMode){p.log(new Date().getTime()+": "+q)}};this.info=function(){if(this.isDebugMode){p.info.apply(p,arguments)}};this.error=function(){if(this.isDebugMode){p.error.apply(p,arguments)}}}var m=new c();function i(r){var q={before:{},after:{}};this.trigger=function(s,v,w){m.log("Triggered hook manager, when - "+s+", event - "+v);if(q[s]&&q[s][v]){for(var t in q[s][v]){var u=q[s][v][t].call(r,w,v);if(u===false){return false;break}}}return true};this.before=function(t,s){if(!q.before[t]){q.before[t]=[]}m.log("Add new hook: when - before, event - "+t);q.before[t].push(s);return this};this.after=function(t,s){if(!q.after[t]){q.after[t]=[]}m.log("Add new hook: when - after, event - "+t);q.after[t].push(s);return this};var p=this;r.after=function(){p.after.apply(p,arguments)};r.before=function(){p.before.apply(p,arguments)}}function o(p,q){m.log("Creating new event emitter with scope "+q.type+(q.type=="global"?"":":"+q.id));p.emit=function(r,s){m.log("Emit event `"+r+"` in scope "+q.type+(q.type=="global"?"":":"+q.id));l.emit("event:emit",{event:r,scope:q,data:s})}}function a(p,u){u=u||"";var r=this;var s=new i(p);var t={};this.getOwner=function(){return p||this};this.getId=function(){if(this.getOwner()===this){return""}return this.getOwner().getId()};this.getHookListener=function(){return s};this.setEventPrefix=function(v){m.log("Set event prefix to: "+v);u=v};this.emit=function(x,y){m.log("Tying to fire event: "+x);if(s.trigger("before",x,y)){if(t[x]){var w={"break":false};for(var v in t[x]){t[x][v].call(p,y,w);if(w["break"]===true){m.log("Handler of event: "+x+" break event chain");break}}}else{m.log("Event ["+x+"] has no listeners")}s.trigger("after",x,y)}m.log("Event ["+x+"] processed!");return p};var q=function(v){var w=r.getId();if(w==""){return u+":"+v}return u+w+":"+v};this.on=function(y,w){m.log("Attach event listener for event: "+y);if(!t[y]){t[y]=[]}t[y].push(w);var v=this;var x=q(y);m.log("Compiled event name: "+x);l.on(x,function(z){m.log("Received data for event: "+y);v.emit(y,z)});return p};p.on=function(w,v){r.on(w,v)}}function j(){var q=this;var p={invoke:function(x){if(x.functions&&typeof x.functions=="object"){for(var t in x.functions){var v=x.functions[t]["function"];var s=x.functions[t]["arguments"];var u=x.functions[t]["scope"];if(window[v]&&typeof window[v]=="function"){if(u&&window[u]){window[v].apply(window[u],s)}else{window[v].apply(window,s)}}}}if(x.methods&&typeof x.methods=="object"){for(var t in x.methods){var v=x.methods[t]["method"];var s=x.methods[t]["arguments"];var u=x.methods[t]["scope"];var w=x.methods[t]["object"];if(window[w]&&typeof window[w]=="object"){if(typeof window[w][v]=="function"){if(u&&typeof window[u]=="object"){window[w][v].apply(window[u],s)}else{window[w][v].apply(window[w],s)}}}}}},jquery:function(s){for(var t in s){var u=s[t];if(u.beforeApply&&window[u.beforeApply]){if(window[u.beforeApply]()===false){continue}}$(u.selector).is(function(){var y=$(this);for(var w in u.actions){var x=u.actions[w].action;var v=u.actions[w].arguments;switch(x){case"remove":y.remove();return;break;case"parents":case"find":case"parent":case"next":case"prev":case"children":y=y[x].apply(y,v);break;default:y[x].apply(y,v);break}}});if(u.afterApply&&window[u.afterApply]){window[u.afterApply]()}}}};var r=function(u,t,s){s.on(u,function(v){m.log("Catch system event "+u);p[u].call(this,v)})};this.attachTo=function(s){for(var t in p){r(t,p[t],s)}}}function n(p){var r=new j();var q=new a(this);this.getId=function(){return"system"};this.getOwner=function(){return p};r.attachTo(this)}function g(p){this._eventListener=new a(this,"room:");this._eventEmitter=new o(this,{type:"room",id:p});this._isJoined=false;this._numberOfClients=0;this._error=false;this._errorMessage="";this.getId=function(){return p};this.getMembersCount=function(){return this._numberOfClients};this.hasError=function(){return this._error};this.isJoined=function(){return this._isJoined};this.on("system:update.members_count",function(q){this._numberOfClients=q;this._eventListener.emit("join",q)});this.join=function(r){if(this.isJoined()){if(r){r.call(this,this.isJoined(),this.getMembersCount())}return}var q=this;m.log("Tying to join in room "+q.getId());l.emit("room_join",q.getId(),function(s,t){q._isJoined=s;if(s){m.log("Joined in room "+q.getId());m.log("Room members count "+t);q._numberOfClients=t}else{q._error=true;q._errorMessage=t;m.log("Room join error: room - "+q.getId()+", reason - "+t)}if(r){r.call(q,s,t)}});return this};this.leave=function(r){if(!r){r=function(){}}if(!this.isJoined()){r.call(this);return}var q=this;l.emit("room_leave",this.getId(),function(){q._isJoined=false;r.call(q)});return this}}function b(p){this._eventListener=new a(this,"alias:");this.getId=function(){return p}}function e(s){this.id=s;this._eventListener=new a(this,"channel:");this._eventEmitter=new o(this,{type:"channel",id:this.id});var r=false;var p={};var q={};this.getId=function(){return s};this.getAttributes=function(){return p};this.getError=function(){return q};this.isConnected=function(){return r};this.join=function(u){if(r){u.call(this,false);return}var t=this;m.log("Tying to join to channel "+this.getId());l.on("connect",function(){l.emit("channel_join",t.getId(),function(w,v){r=!v;if(v){m.log("Channel join error - "+t.getId()+", reason - "+w.errorMessage);q=w}else{p=w}if(u){u.call(t,!v)}})});return this};this.leave=function(u){if(!u){u=function(){}}if(!this.isConnected()){u.call(this);return}var t=this;l.emit("channel_leave",t.getId(),function(){r=false;u.call(t)});return this}}function k(){var q=this;this._eventListener=new a(this,"global");this._eventEmitter=new o(this,{type:"global"});l=io.connect("http://ws.b.oldbk.com:8880/client");var p=new n(this);this.getId=function(){return""};this.debug=function(r){m.isDebugMode=r;return this};this.getSocket=function(){return l};this.getLogger=function(){return m};this.getPublicData=function(r,s){m.log("Trying to get public data for key: "+r);l.emit("public_data",r,function(t){m.log("Received public data for key: "+r);if(s){s(t)}})};this.room=function(s){if(f[s]){return f[s]}var r=f[s]=new g(s);return r};this.channel=function(s){if(h[s]){return h[s]}var r=h[s]=new e(s);return r};this.alias=function(r){if(d[r]){return d[r]}return d[r]=new b(r)};this.onConnect=function(r){if(r){l.on("connect",r)}};this.onDisconnect=function(r){if(r){l.on("disconnect",r)}};this.onConnecting=function(r){if(r){l.on("connecting",r)}};this.onReconnect=function(r){if(r){l.on("reconnect",r)}}}window.YiiNodeSocket=k})();