var mysql=require("mysql");function Model(a){this.table=a;this.connector=null}Model.prototype.setConnector=function(a){this.connector=a};Model.prototype.findByPk=function(c,b){var a=this;if(typeof c=="string"||typeof c=="number"){c=[c]}this.connector.getConnection(function(d){var e="SELECT * FROM `"+a.table+"` WHERE id IN("+c.join(",")+")";d.query(e,b)})};Model.prototype.count=function(c,b){var a=this;this.connector.getConnection(function(e){var g="SELECT COUNT(*) as cnt FROM `"+a.table+"` WHERE 1";if(b){var d=[];for(var f in b){d.push(f+" = :"+f)}g+=" AND "+d.join(" AND ")}else{b={}}e.query(g,b,function(i,h){c(i,i?null:h[0]["cnt"])})})};Model.prototype.get=function(d,c,e,a){var b=this;this.connector.getConnection(function(g){var h="";if(c){var f=[];for(var i in c){f.push(i+" = :"+i)}if(f.length>0){h+=" AND "+f.join(" AND ")}}else{c={}}if(!e&&!a){g.query("SELECT * FROM `"+b.table+"` WHERE 1 "+h,c,d)}else{g.query("SELECT * FROM `"+b.table+"` WHERE 1 "+h+" LIMIT "+e+","+a,c,d)}})};function Channel(){}Channel.prototype=new Model("ns_channel");Channel.prototype._get=Channel.prototype.get;Channel.prototype.get=function(b,c,a){this._get(function(f,d){if(!f){for(var e in d){if(d[e].properties){d[e].properties=JSON.parse(d[e].properties)}}}b(f,d)},c,a)};function Subscriber(){}Subscriber.prototype=new Model("ns_subscriber");function ChannelSubscriber(){}ChannelSubscriber.prototype=new Model("ns_channel_subscriber");var connector={_options:null,_connectionOptions:null,_connection:null,_parseDsn:function(a){this._connectionOptions.host=a.split(";")[0].split("=")[1];this._connectionOptions.database=a.split(";")[1].split("=")[1]},_createConnection:function(b){if(!this._connectionOptions){this._connectionOptions={};if(this._options.dsn){this._parseDsn(this._options.dsn)}this._connectionOptions.user=this._options.username;this._connectionOptions.password=this._options.password}var a=this;this._connection=mysql.createConnection(this._connectionOptions);this._connection.config.queryFormat=function(d,c){if(!c){return d}return d.replace(/\:(\w+)/g,function(e,f){if(c.hasOwnProperty(f)){return this.escape(c[f])}return e}.bind(this))};this._connection.connect(function(c){if(c){console.log("error when connecting to db:",c)}else{if(b){b(a._connection)}a._connection.on("error",function(d){console.log("db error",d);if(d.code==="PROTOCOL_CONNECTION_LOST"){a._createConnection()}else{throw d}})}})},init:function(a){this._options=a;this.channel=new Channel();this.channel.setConnector(this);this.subscriber=new Subscriber();this.subscriber.setConnector(this);this.channelSubscriber=new ChannelSubscriber();this.channelSubscriber.setConnector(this);return true},getConnection:function(a){if(this._connection){a(this._connection)}else{this._createConnection(a)}},channel:null,subscriber:null,channelSubscriber:null};module.exports=connector;