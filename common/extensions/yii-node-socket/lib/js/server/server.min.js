var express=require("express");var app=express();var server=require("http").createServer(app);var io=require("socket.io").listen(server);var cookie=require("cookie");var serverConfiguration=require("./server.config.js");var storeProvider=express.session.MemoryStore;var sessionStorage=new storeProvider();var componentManager=require("./components/component.manager.js");componentManager.set("config",serverConfiguration);var eventManager=require("./components/event.manager.js");var socketPull=require("./components/socket.pull.js");var db=require("./components/db.js");db.init(serverConfiguration.dbOptions);componentManager.set("db",db);componentManager.set("sp",socketPull);componentManager.set("io",io);componentManager.set("eventManager",eventManager);componentManager.set("sessionStorage",sessionStorage);server.listen(serverConfiguration.port,serverConfiguration.host);console.log("Listening "+serverConfiguration.host+":"+serverConfiguration.port);if(serverConfiguration.checkClientOrigin){console.log("Set origin: "+serverConfiguration.origin);io.set("origins",serverConfiguration.origin)}io.of("/client").authorization(function(c,b){if(!c.headers.cookie){return b("NO COOKIE TRANSMITTED",false)}c.cookie=cookie.parse(c.headers.cookie);var a=c.cookie[serverConfiguration.sessionVarName];if(!a){return b("Have no session id",false)}c.sid=a;c.uid=null;c.writeSession=function(d){sessionStorage.set(a,c.session,function(){if(d){d()}})};sessionStorage.get(a,function(d,e){var f=function(){var g={sid:a,cookie:c.cookie,user:{role:"guest",id:null,isAuthenticated:false}};sessionStorage.set(a,g,function(){c.session=g;b(null,true)})};if(d||!e){if(!e){f()}else{b("ERROR: "+d,false)}}else{if(!e){f()}else{c.session=e;c.uid=e.user.id;b(null,true)}}})}).on("connection",function(a){socketPull.add(a);componentManager.get("channel").attachToChannels(a);eventManager.client.bind(a)});io.of("/server").authorization(function(d,b){if(d&&d.address){if(d.headers.cookie){d.cookie=cookie.parse(d.headers.cookie);if(d.cookie.PHPSESSID){d.sid=d.cookie.PHPSESSID;var c=false;for(var a in serverConfiguration.allowedServers){if(serverConfiguration.allowedServers[a]==d.address.address){c=true;break}}if(c){var e=function(){var f={sid:d.cookie.PHPSESSID,cookie:d.cookie,user:{role:"guest",id:null,isAuthenticated:false}};sessionStorage.set(d.cookie.PHPSESSID,f,function(){d.session=f;b(null,true)})};d.writeSession=function(f){sessionStorage.set(d.cookie.PHPSESSID,d.session,function(){if(f){f()}})};sessionStorage.get(d.cookie.PHPSESSID,function(f,g){if(f||!g){if(!g){e()}else{b("ERROR: "+f,false)}}else{if(!g){e()}else{d.session=g;d.uid=g.user.id;b(null,true)}}})}else{b("INVALID SERVER: server host "+d.address.address+" not allowed")}}else{b("PHPSESSID is undefined",false)}}else{b("No cookie",false)}}else{b("NO ADDRESS TRANSMITTED.",false);return false}}).on("connection",function(a){eventManager.server.bind(a)});componentManager.initCompleted();