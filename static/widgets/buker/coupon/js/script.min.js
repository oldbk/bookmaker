var $coupon=new Coupon();$(function(){$coupon.run();$(window).on("user:ready",function(){$coupon.run();$(window).off("user:ready")});$(window).on("page:loaded",function(){$coupon.run()});$(document.body).on("touchstart click","#coupon table.coupon-tabs td:not(.active)",function(a){DEBUG(_d,"info","Coupon","Click tab");var b=$(this);b.closest("tr").find("td").removeClass("active");b.addClass("active");if(b.data("type")=="single"){$coupon.setSingle()}else{$coupon.setExpress()}});$(document.body).on("touchstart click","#bet-list td div.ratio span.c-ratio",function(g){g.preventDefault();var h=$(this);var d=h.closest("tr").data("event");var f=h.data("value");var c=h.data("type");var b=h.data("num");var a=h.hasClass("active");$('[data-event="'+d+'"]').find("span.c-ratio").removeClass("active");if(a){$coupon.removeEvent(d)}else{$coupon.addEvent(d,c,f,b)}h.addClass("no-hover")});$(document.body).on("mouseout","#bet-list td div.ratio span.c-ratio",function(a){a.preventDefault();$(this).removeClass("no-hover")});$(document.body).on("touchstart click","#coupon .bet_block .bet_item .close",function(b){b.preventDefault();var c=$(this);var a=c.closest(".bet_item").data("event");$coupon.removeEvent(a)});$(document.body).on("keyup","#coupon input.bet-price",function(){var a=$(this).closest(".bet_item").data("event");$coupon.setEventPrice(a,$(this).val())});$(document.body).on("touchstart click","#coupon .buttons #bet-clear",function(){$coupon.clear()});$(document.body).on("touchstart click","#coupon .buttons #bet-send",function(){$coupon.submit()});$(window).on("change:currency",function(){$coupon.clear()})});function Coupon(){var c=this;var p={debug:_d,list:{},liga_list:{},count:0,isExpress:0,express_sum:0,linkExpress:null,linkSingle:null,linkInfo:null,currency:null,storage:null,$content:null,$content_items:null,$content_loader:null,$content_summary:null,$content_buttons:null};var n=function(){DEBUG(p.debug,"info","Coupon","_prepareData");var q=$.initNamespaceStorage("Coupon");p.storage=q.localStorage;p.currency=$user.getCurrencyName();p.$content=$("#coupon .content");p.$content_items=$("#coupon .content #coupon-content-wrapp");p.$content_loader=$("#coupon .content #coupon-loader-wrapp");p.$content_summary=$("#coupon .content #coupon-summary-wrapp");p.$content_buttons=$("#coupon .content #coupon-buttons-wrapp");p.list={};p.liga_list={};p.count=0;c.empty();if(!p.storage.isEmpty("list")&&p.storage.get("expire")>new Date().getTime()){$.each(p.storage.get("list"),function(r,s){b(s)})}if(p.count>0){c.empty(true)}};this.run=function(){n();$("#coupon").fBlock();c.setSingle()};this.clear=function(){DEBUG(p.debug,"info","Coupon","clear");p.storage.removeAll();$.each(p.list,function(q,r){l(q)});p.$content_buttons.html("");p.$content_summary.html("");p.$content_loader.html("");c.empty()};this.submit=function(){DEBUG(p.debug,"info","Coupon","clear");var q=p.isExpress?j():k();var r=function(s){if(s.update!==undefined){$.each(s.update,function(t,u){$coupon.updateEvent(u)})}if(s.remove!==undefined){$.each(s.remove,function(t,u){$coupon.removeEvent(u)})}if(s.bet!==undefined&&s.bet=="success"){$coupon.clear()}};$ajax.send(m(),{data:q},null,null,null,null,null,r)};this.setEventPrice=function(r,q){DEBUG(p.debug,"info","Coupon","setEventPrice",r,q);if(p.isExpress){p.express_sum=q}else{p.list[r]["price"]=q}h()};this.setIsExpress=function(q){DEBUG(p.debug,"info","Coupon","setIsExpress",q);p.isExpress=q;return c};this.setSingle=function(){DEBUG(p.debug,"info","Coupon","setSingle");c.setIsExpress(false);if(p.count>0){p.$content_items.find("input").prop("readonly",false);f(true);h()}};this.setExpress=function(){DEBUG(p.debug,"info","Coupon","setExpress");c.setIsExpress(true);if(p.count>0){p.$content.find("input").prop("readonly",true);f();h()}};this.setLinks=function(s,q,r){DEBUG(p.debug,"info","Coupon","setLinks",s,q,r);p.linkExpress=s;p.linkSingle=q;p.linkInfo=r};this.setCurrency=function(q){DEBUG(p.debug,"info","Coupon","setCurrency",q);p.currency=q};this.addEvent=function(u,t,w,r){DEBUG(p.debug,"info","Coupon","addEvent",u,t,w,r);var v={"Bet[event]":u,"Bet[type]":t,"Bet[value]":w,"Bet[num]":r};if(p.count==0){c.empty(true)}var q=function(){$coupon.loader()};var s=function(y){$coupon.loader(true);if(y.event_info!==undefined){$coupon.addEventToCoupon(y.event_info)}else{$coupon.empty()}};var x=function(){$coupon.loader(true);$coupon.empty()};$ajax.send(p.linkInfo,v,null,null,false,null,q,s,x)};this.updateEvent=function(r){DEBUG(p.debug,"info","Coupon","updateEvent",r);var q=r.id;p.list[q]["ratio_value"]=r.value;h()};this.removeEvent=function(q){DEBUG(p.debug,"info","Coupon","removeEvent",q);l(q);if(p.count===0){c.empty()}h()};this.addEventToCoupon=function(q){DEBUG(p.debug,"info","Coupon","addEventToCoupon",q);b(q);h()};this.loader=function(q){DEBUG(p.debug,"info","Coupon","loader",q);if(q===true){p.$content_loader.html("")}else{p.$content_loader.html($("<div>",{"class":"loader-block"}).append('<div class="bet-loader-element"></div>'))}};this.empty=function(q){DEBUG(p.debug,"info","Coupon","empty",q);if(q===true){p.$content_items.find(".empty-coupon").remove()}else{p.$content_items.html($("<div>",{"class":"empty-coupon"}).append("Купон пустой"))}};var b=function(r){DEBUG(p.debug,"info","Coupon","_addEventToCoupon",r);if(p.list[r.event_id]!==undefined){l(r.event_id)}if(p.count==0){g();$("#coupon #coupon_block").collapse("show");if(p.isExpress){f()}}$('tr[data-event="'+r.event_id+'"] span[data-type="'+r.ratio_type+'"]').addClass("active");var q=i(r);var s=null;if(p.liga_list[r.liga_id]!==undefined&&p.liga_list[r.liga_id]>0){s=p.$content_items.find('.bet_block[data-liga="'+r.liga_id+'"]');p.liga_list[r.liga_id]++}else{s=a(r).appendTo(p.$content_items);p.liga_list[r.liga_id]=1}if(r.price===undefined){r.price=0}s.append(q);p.list[r.event_id]=r;p.count++};var l=function(q){DEBUG(p.debug,"info","Coupon","_removeEvent",q);var r=p.list[q];p.$content_items.find('.bet_item[data-event="'+q+'"]').remove();p.liga_list[r.liga_id]--;if(p.liga_list[r.liga_id]==0){p.$content_items.find('.bet_block[data-liga="'+r.liga_id+'"]').remove()}p.count--;delete p.list[q];$('[data-event="'+q+'"]').find("span.c-ratio").removeClass("active");if(p.count==0){c.clear()}};var h=function(){DEBUG(p.debug,"info","Coupon","_updateForm");if(p.isExpress){o()}else{d()}var q=new Date();q.setMinutes(q.getMinutes()+10);p.storage.set("list",$.extend({},p.list));p.storage.set("currency",p.currency);p.storage.set("expire",q.getTime())};var d=function(){DEBUG(p.debug,"info","Coupon","_updateSingle");$.each(p.list,function(s,t){var q=p.$content_items.find('.bet_item[data-event="'+s+'"]');q.find(".ratio-value").html(t.ratio_value);var r=$.prepare(t.ratio_value)*$.prepare(t.price);if(t.price>0){q.find("input.bet-price").val(t.price)}q.find(".coupon-res").html($.prepare(r)+p.currency)})};var o=function(){DEBUG(p.debug,"info","Coupon","_updateExpress");var t=1;$.each(p.list,function(v,w){var u=p.$content_items.find('.bet_item[data-event="'+v+'"]');u.find(".ratio-value").html(w.ratio_value);if(w.price>0){u.find("input.bet-price").val(w.price)}u.find(".coupon-res").html("0.00"+p.currency);t=t*w.ratio_value});var r=p.$content_summary.find("input.bet-price");t=$.prepare(t);p.express_sum=$.prepare(r.val());p.$content_summary.find(".sum_ratio").html(t);var s=t*p.express_sum;p.$content_summary.find(".coupon-res").html($.prepare(s)+p.currency);var q=e();r.prop("title","max "+q+p.currency).attr("data-original-title","max "+q+p.currency)};var j=function(){DEBUG(p.debug,"info","Coupon","_getExpressData");var r={items:{},price:p.$content.find("#sum_block input.bet-price").val()};var q;$.each(p.list,function(s,t){q={event_id:s,title:t.event_title,ratio_type:t.ratio_type,ratio_value:t.ratio_value};r.items[s]=q});return r};var k=function(){DEBUG(p.debug,"info","Coupon","_getSingleData");var r={};var q;$.each(p.list,function(s,t){q={event_id:s,title:t.event_title,ratio_type:t.ratio_type,ratio_value:t.ratio_value,price:p.$content_items.find('.bet_item[data-event="'+s+'"] input.bet-price').val()};r[s]=q});return r};var a=function(q){DEBUG(p.debug,"info","Coupon","_buildLiga",q);return $("<div>",{"class":"bet_block","data-liga":q.liga_id}).append(' <div class="bet_head">'+q.liga_title+"</div>")};var i=function(r){DEBUG(p.debug,"info","Coupon","_buildEvent",r);var q=$("<table>",{"class":"table list-event"}).append('<colgroup><col width="23px"><col width=""><col width="35px"><col width="50px"><col width="75px"></colgroup>');q.append($("<thead>").append('<tr class="bet_item_head"><th colspan="5">'+r.event_title+"</th></tr>"));var s=$("<input>",{"data-toggle":"tooltip",type:"text",title:"max "+r.max_bet+p.currency,"class":"bet-price form-control double",readonly:p.isExpress});$("<tbody>").append($("<tr>").append($("<td>").append($("<span>",{"class":"glyphicon glyphicon-remove-circle close pointer"}))).append($("<td>").append(r.ratio_type_string)).append($("<td>",{"class":"ratio-value"}).append(r.ratio_value)).append($("<td>").append(s)).append($("<td>",{"class":"coupon-res"}).append("0.00"+p.currency))).appendTo(q);return $("<div>",{"class":"bet_item","data-event":r.event_id}).append($("<div>",{"class":"bet_item_ratio"}).append(q))};var m=function(){return p.isExpress==true?p.linkExpress:p.linkSingle};var e=function(){DEBUG(p.debug,"info","Coupon","_getMaxBet");var r=0;var q=0;$.each(p.list,function(s,t){q=parseFloat(t.max_bet);if(r==0||r>q){r=q}});return r};var f=function(s){DEBUG(p.debug,"info","Coupon","_summary");if(s===true){p.$content_summary.html("")}else{if(p.$content_summary.find(".sum_block").length){return}var u=$("<div>",{id:"sum_block"});var r=$("<table>").appendTo(u);r.append('<colgroup><col width="23px"><col width=""><col width="35px"><col width="50px"><col width="75px"></colgroup>');var q=$("<tbody>").appendTo(r);var v=$("<input>",{"data-toggle":"tooltip",type:"text","class":"bet-price form-control double"});var t=$("<tr>").appendTo(q);t.append("<td></td>").append("<td></td>").append('<td class="sum_ratio"></td>').append($("<td>").append(v)).append('<td class="coupon-res">0.00'+p.currency+"</td>");p.$content_summary.html(u)}};var g=function(q){DEBUG(p.debug,"info","Coupon","_buttons",q);if(q===true){p.$content_buttons.html("")}else{var r=$("<div>",{"class":"buttons"}).append('<a href="javascript:void(0);" class="label label-none" id="bet-clear">Очистить</a>').append('<a href="javascript:void(0);" class="label label-active" id="bet-send">Сделать ставку</a>');p.$content_buttons.html(r)}}};